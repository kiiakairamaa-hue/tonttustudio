<!DOCTYPE html>
<!-- =========================================================
     ‚ö†Ô∏è TURVAVERSIO
     T√§m√§ on varmistettu, t√§ysin toimiva versio Joulugeneraattorista.
     √ÑL√Ñ MUOKKAA t√§t√§ tiedostoa ‚Äî k√§yt√§ kopiota kehitykseen.
     --------------------------------------------------------- -->
<html lang="fi">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!------------ FONTIT --------->
<link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!------------ NIMI --------->
<title>TonttuStudio ‚Äì Lis√§√§ tunnelmaa jouluun ‚ú®</title>

<!-- =========================================================
     üé® TYYLIT / CSS
     --------------------------------------------------------- -->
<style>
html, body {
  margin: 0;
  padding: 0;
}

/* --- Allekirjoitus / Credits --- */
.credits {
  width: 100%;
  text-align: center;
  font-size: 17px;
  color: #ffe7a5;
  opacity: 0.95;
  margin-top: 80px;
  padding: 0 0 20px 0;
  font-family: "Fredoka", sans-serif;
  text-shadow: 0 1px 3px rgba(0,0,0,0.6);
  box-sizing: border-box;
  line-height: 1.25;
}

.credits-name {
  font-size: 14px;
  opacity: 0.75;
  margin-top: 4px;
}

/* -------------------- V√§rit ja perusfontit -------------------- */
:root{
  --red:#8d1b1b;
  --gold:#f6d778;
  --gold-edge:#7f642a;
}

html,body{height:100%}

body{
  margin:0;
  background:var(--red);
  color:#fff;
  font-family: 'Fredoka', sans-serif;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}

/* -------------------- Sivun runko -------------------- */
.wrap {
  max-width:720px;
  margin:0 auto;
  padding:16px;
  position: relative;
}

/* -------------------- Sticky-otsikko -------------------- */
h1 {
  position: sticky;
  top: 0;
  z-index: 200;
  margin: 0;
  padding: 10px 0 10px;
  background: var(--red);

  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 8px;

  font-size: 42px;
  line-height: 1.05;
  color: #ffd700;
  text-shadow: 
    0 2px 0 rgba(0,0,0,.25),
    0 0 16px rgba(243,209,119,.35);
  font-weight: 700;
  font-family: 'Emilys Candy', cursive;
  letter-spacing: .3px;
}

/* üßù‚Äç‚ôÇÔ∏è tontun s√§√§t√∂ */
.title-tonttu {
  height: 60px;
  display: block;
  align-self: flex-end;
  margin-bottom: -2px;
  margin-right: 2px;
}

/* -------------------- Ty√∂kalupalkin napit -------------------- */
.toolbar{
  display:flex;
  gap:10px;
  justify-content:center;
  align-items:center;
  margin-bottom:12px;
  flex-wrap:nowrap;
  overflow-x:auto;
  padding:2px;
}

button,
label.button{
  white-space:nowrap;
  background:linear-gradient(#ffe7a5,#e5c66d);
  color:#2b1c00;
  border:2px solid var(--gold-edge);
  padding:10px 18px;
  font-weight:500;
  border-radius:24px;
  font-size:16px;
  box-shadow:0 4px 0 #6e5624, 0 8px 18px rgba(0,0,0,.25);
  cursor:pointer;
  touch-action:manipulation;
  font-family: 'Fredoka', sans-serif;
}

input[type=file]{display:none}

/* -------------------- Esikatseluruutu -------------------- */
.preview{
  width: calc(100% + 32px);
  max-width: none;
  margin: 0 -16px 18px;

  aspect-ratio: 1/1;
  background: #121212;
  border-radius: 16px;
  border: 3px solid var(--gold);
  overflow: hidden;

  position: sticky;
  top: 66px;
  z-index: 50;

  touch-action: none;

  box-shadow: 0 18px 40px rgba(0,0,0,0.7);
  transform: scale(0.95);
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

/* üìå Ohjeteksti */
.preview-hint {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: #f6d778;
  font-size: 18px;
  font-family: 'Fredoka', sans-serif;
  opacity: 0.75;
  pointer-events: none;
  text-align: center;
  padding: 4px 8px;
}

/* -------------------- Pieni ohjeteksti -------------------- */
.note{
  text-align:left;
  color:#ffe7a5;
  font-size:13px;
  margin:8px 0 12px;
  line-height:1.35;
}

/* -------------------- Pikkukuvat -------------------- */
.thumbs{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:10px;
  padding:4px 2px 2px;
  margin-bottom:6px;
}

.thumb{
  border-radius:14px;
  padding:6px;
  background:rgba(0,0,0,.55);
  box-shadow:0 0 0 2px rgba(243,209,119,.30) inset, 0 6px 16px rgba(0,0,0,.35);
  display:flex;
  align-items:center;
  justify-content:center;
  aspect-ratio:1/1;
  overflow:hidden;
}

.thumb img{
  max-width:100%;
  max-height:100%;
  display:block;
  cursor:pointer;
  user-select:none;
  -webkit-user-drag:none;
}

/* Otsikot kirjastossa */
.thumb-title {
  font-family: 'Fredoka', sans-serif;
  font-size: 17px;
  font-weight: 500;
  color: #f6d778;
  text-align: left;
  padding-left: 4px;
  margin: 10px 0 4px;
  opacity: 0.92;
  letter-spacing: 0.4px;
  grid-column: 1 / -1;
}

/* Poistoruksi */
.remove-btn{
  position:absolute;
  color:#fff;
  font-weight:900;
  font-size:22px;
  line-height:1;
  text-shadow: 0 1px 2px rgba(0,0,0,.7), 0 0 6px rgba(0,0,0,.5);
  user-select:none;
  z-index:5;
  pointer-events:auto;
  transform:translate(-50%,-50%);
}

/* Kun ei ole taustakuvaa ‚Üí ruutu saa scrollata */
.preview.scroll-mode {
  touch-action: pan-y;
}
</style>

<!------------ HEIC ‚Üí PNG KIRJASTO --------->
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>

<body>
<div class="wrap">

<!------------ OTSIKKO --------->
<h1>
  <img 
    src="https://raw.githubusercontent.com/tonttustudio/tonttustudio/main/Otsikontonttu1.png"
    class="title-tonttu"
    alt="Tonttu"
  />
  TonttuStudio
</h1>

<!------------ TY√ñKALUPALKIN NAPIT --------->
<div class="toolbar">
  <label for="file" class="button">Avaa kuva</label>
  <input id="file" type="file" accept="image/*,image/heic,image/heif,image/webp"/>
  <button id="save">Tallenna</button>
  <button id="clear">Tyhjenn√§</button>
</div>

<!------------ ESIKATSELU --------->
<div class="preview" id="preview">
  <canvas id="c" width="1200" height="1200"></canvas>

  <div class="preview-hint">Napauta lis√§t√§ksesi kuvan</div>
</div>

<!------------ NOTE --------->
<div class="note">
  Avaa kuva, sovita ruutuun ja lis√§√§ koristeita. Muokkaus ja kiert√§minen kahdella sormella.
</div>

<!------------ JAVASCRIPT --------->
<script>
let bgBitmap = null;

(function(){
'use strict';

/* -------------------- Asetukset -------------------- */
const MAX_LONG_EDGE = 3000;
const BG_MIN = 0.2, BG_MAX = 6.0;
const STICKER_MIN = 0.4, STICKER_MAX = 10.0;
const BASE_STICKER = 300;

/* -------------------- DOM-viittaukset -------------------- */
const file = document.getElementById('file');
const save = document.getElementById('save');
const clearBtn = document.getElementById('clear');
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });
const preview = document.getElementById('preview');
const previewHint = document.querySelector('.preview-hint');   <!-- üî• T√ÑM√Ñ LIS√ÑTTY -->

clearCanvas(ctx);

/* -------------------- Klikkaa esikatselua ‚Üí avaa kuva -------------------- */
preview.addEventListener('click', () => {
  if (!bgBitmap) file.click();
});

/* -------------------- Taustapuskuri -------------------- */
const back = document.createElement('canvas');
back.width = canvas.width;
back.height = canvas.height;
const bctx = back.getContext('2d', {alpha:false});

/* -------------------- Tilat -------------------- */
let saveCount = 1;
let bg = { x:0, y:0, scale:1 };
let bgLocked = false;
let stickers = [];
let activeIndex = -1;
let needsRedraw = true;
let pointers = new Map();
let draggingBG = false;
let stickerGesture = null;

/* -------------------- Poistonappi -------------------- */
const delBtn = document.createElement('div');
delBtn.className = 'remove-btn';
delBtn.textContent = 'x';
delBtn.style.display = 'none';
preview.appendChild(delBtn);

delBtn.addEventListener('click', ()=>{
  if(activeIndex>=0){
    stickers.splice(activeIndex,1);
    activeIndex = stickers.length-1;
    if(stickers.length===0) bgLocked=false;
    needsRedraw=true;
    updateDeleteButtonPosition();
  }
});

/* -------------------- Piirtosilmukka -------------------- */
requestAnimationFrame(function loop(){
  if(needsRedraw){
    draw();
    needsRedraw=false;
  }
  requestAnimationFrame(loop);
});

/* -------------------- Piirtotoiminnot -------------------- */
function clearCanvas(target){
  const t = target||ctx;
  t.fillStyle = '#121212';
  t.fillRect(0,0,canvas.width,canvas.height);
}

function renderTo(targetCtx){
  targetCtx.fillStyle='#121212';
  targetCtx.fillRect(0,0,canvas.width,canvas.height);

  if(bgBitmap){
    targetCtx.save();
    targetCtx.imageSmoothingEnabled=true;
    targetCtx.imageSmoothingQuality='high';
    targetCtx.translate(bg.x,bg.y);
    targetCtx.scale(bg.scale,bg.scale);
    targetCtx.drawImage(bgBitmap,0,0);
    targetCtx.restore();
  }

  for(const st of stickers){
    targetCtx.save();
    targetCtx.translate(st.x, st.y);
    targetCtx.rotate(st.rot);
    targetCtx.scale(st.scale, st.scale);
    const img=st.bitmap;
    const w=img.width, h=img.height;
    const scale=Math.min(BASE_STICKER/w, BASE_STICKER/h);
    targetCtx.scale(scale, scale);
    targetCtx.drawImage(img, -w/2, -h/2);
    targetCtx.restore();
  }
}

function drawOutlineForActive(){
  if(activeIndex<0 || !stickers[activeIndex]) return;
  const st = stickers[activeIndex];

  ctx.save();
  ctx.translate(st.x, st.y);
  ctx.rotate(st.rot);
  const img = st.bitmap, w=img.width, h=img.height;
  const inner = Math.min(BASE_STICKER/w, BASE_STICKER/h) * st.scale;

  ctx.scale(inner, inner);
  ctx.lineWidth = 3 / inner;
  ctx.strokeStyle = '#f6d778';
  ctx.shadowColor='rgba(246,215,120,.35)';
  ctx.shadowBlur=14;
  ctx.lineJoin='round';

  roundedRectPath(ctx, -w/2, -h/2, w, h, Math.min(w,h)*0.12);
  ctx.stroke();
  ctx.restore();

  updateDeleteButtonPosition();
}

function roundedRectPath(g, x, y, w, h, r){
  const rr = Math.min(r, Math.abs(w)/2, Math.abs(h)/2);
  g.beginPath();
  g.moveTo(x+rr, y);
  g.lineTo(x+w-rr, y);
  g.quadraticCurveTo(x+w, y, x+w, y+rr);
  g.lineTo(x+w, y+h-rr);
  g.quadraticCurveTo(x+w, y+h, x+w-rr, y+h);
  g.lineTo(x+rr, y+h);
  g.quadraticCurveTo(x, y+h, x, y+h-rr);
  g.lineTo(x, y+rr);
  g.quadraticCurveTo(x, y, x+rr, y);
  g.closePath();
}

function draw(){
  renderTo(bctx);
  ctx.drawImage(back,0,0);
  drawOutlineForActive();
}

/* -------------------- Poistonappi ‚Üí paikan laskenta -------------------- */
function updateDeleteButtonPosition(){
  if(activeIndex<0 || !stickers[activeIndex]){
    delBtn.style.display='none';
    return;
  }
  delBtn.style.display='block';
  const st = stickers[activeIndex];
  const rect = canvas.getBoundingClientRect();
  const scaleX = rect.width / canvas.width;
  const scaleY = rect.height / canvas.height;
  const img = st.bitmap, w=img.width, h=img.height;
  const innerScale = Math.min(BASE_STICKER/w, BASE_STICKER/h) * st.scale;
  const px = (st.x + (w/2)*innerScale) * scaleX + rect.left;
  const py = (st.y - (h/2)*innerScale) * scaleY + rect.top;
  const pr = preview.getBoundingClientRect();
  delBtn.style.left = (px - pr.left + 6) + 'px';
  delBtn.style.top  = (py - pr.top  - 6) + 'px';
}

/* -------------------- Kuva lataus -------------------- */
file.addEventListener('change', async (e)=>{
  const f = e.target.files && e.target.files[0];
  if(!f) return;

  const label = document.querySelector('label[for="file"]');
  const originalText = label.textContent;
  label.textContent = "LATAAN‚Ä¶";
  label.style.opacity = "0.6";
  label.style.pointerEvents = "none";

  try{
    const isHeic=(/\.hei[cf]$/i.test(f.name||'')||/heic|heif/i.test(f.type||''));
    if(isHeic && window.heic2any){
      const pngBlob=await window.heic2any({blob:f,toType:'image/png'});
      const url=URL.createObjectURL(pngBlob);
      const img=await loadImg(url);
      URL.revokeObjectURL(url);
      bgBitmap=canvasFrom(img);
    }else{
      const bmp=await createImageBitmap(f,{imageOrientation:'from-image'});
      bgBitmap=downscaleToMaxEdge(bmp);
      if(bmp.close) try{ bmp.close(); }catch(_){}
    }

    fitContain();
    clampBgScale();
    needsRedraw = true;

    if (previewHint) previewHint.style.display = "none";

    updateScrollMode();

  } catch {
    alert('Kuvan avaaminen ep√§onnistui.');
  }
  finally {
    e.target.value = '';
    label.textContent = originalText;
    label.style.opacity = '1';
    label.style.pointerEvents = 'auto';
  }
});

/* -------------------- Reset -------------------- */
clearBtn.addEventListener('click', resetAll);

function resetAll(){
  bgBitmap=null;
  bg={x:0,y:0,scale:1};
  bgLocked=false;
  stickers=[];
  activeIndex=-1;
  saveCount=1;
  clearCanvas(ctx);
  clearCanvas(bctx);
  needsRedraw=true;
  delBtn.style.display='none';
  updateScrollMode();

  if (previewHint) previewHint.style.display="block";
}

/* -------------------- Tallennus -------------------- */
function pad3(n){ return String(n).padStart(3,'0'); }

save.addEventListener('click', ()=>{
  const off=document.createElement('canvas');
  off.width=canvas.width;
  off.height=canvas.height;
  const g=off.getContext('2d',{alpha:false});
  renderTo(g);
  const filename=`Joulugeneraattori_${pad3(saveCount)}.png`;
  off.toBlob((blob)=>{
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{
      URL.revokeObjectURL(a.href);
      a.remove();
    },1000);
    saveCount++;
  },'image/png',0.95);
});

/* -------------------- Pikkukuvat ‚Üí Koristeeksi -------------------- */
window.addEventListener('load', ()=>{
  const thumbs = document.getElementById('thumbs');
  if(!thumbs) return;

  async function addStickerFromUrl(url){
    const img=new Image();
    img.crossOrigin='anonymous';
    await new Promise((r,j)=>{
      img.onload=r;
      img.onerror=j;
      img.src=url;
    });
    const off=document.createElement('canvas');
    off.width=img.naturalWidth;
    off.height=img.naturalHeight;
    const g=off.getContext('2d');
    g.imageSmoothingEnabled=true;
    g.imageSmoothingQuality='high';
    g.drawImage(img,0,0);
    stickers.push({bitmap:off,x:canvas.width/2,y:canvas.height/2,scale:1,rot:0});
    activeIndex=stickers.length-1;
    if(stickers.length>0) bgLocked=true;
    needsRedraw=true;
    updateDeleteButtonPosition();
  }

  thumbs.addEventListener('click', async (e)=>{
    if(e.target.tagName!=='IMG' || !e.target.src) return;
    await addStickerFromUrl(e.target.src);
  });
});

/* -------------------- Eleet: BG ja stickerit -------------------- */
canvas.addEventListener('pointerdown', (e)=>{
  canvas.setPointerCapture(e.pointerId);
  pointers.set(e.pointerId,{x:e.clientX, y:e.clientY});
  const p=coords(e);

  let newActive=-1;
  for(let i=stickers.length-1;i>=0;i--){
    const st=stickers[i];
    const box=140*st.scale;
    if(Math.abs(p.x-st.x)<box && Math.abs(p.y-st.y)<box){
      newActive=i;
      break;
    }
  }
  activeIndex=newActive;
  updateDeleteButtonPosition();

  draggingBG=(activeIndex===-1 && !bgLocked);
});

canvas.addEventListener('pointermove', (e)=>{
  if(!pointers.has(e.pointerId)) return;
  const ent=pointers.get(e.pointerId);
  const dx=e.clientX-ent.x;
  const dy=e.clientY-ent.y;
  ent.x=e.clientX;
  ent.y=e.clientY;

  const pts=[...pointers.values()];
  const r=canvas.getBoundingClientRect();
  const sx=canvas.width/r.width;
  const sy=canvas.height/r.height;

  if(activeIndex!==-1){
    const st=stickers[activeIndex];
    if(pts.length===1){
      st.x += dx*sx;
      st.y += dy*sy;
    }
    needsRedraw=true;
    updateDeleteButtonPosition();
    return;
  }

  if(!bgLocked){
    if(pts.length===1 && draggingBG){
      bg.x += dx*sx;
      bg.y += dy*sy;
      needsRedraw=true;
    }
  }
});

canvas.addEventListener('pointerup', endPointer);
canvas.addEventListener('pointercancel', endPointer);
canvas.addEventListener('pointerleave', endPointer);

function endPointer(e){
  pointers.delete(e.pointerId);
  draggingBG=false;
}

function coords(e){
  const r=canvas.getBoundingClientRect();
  return {
    x:(e.clientX-r.left)*(canvas.width/r.width),
    y:(e.clientY-r.top)*(canvas.height/r.height)
  };
}

})();
</script>

<script>
function updateScrollMode() {
  const preview = document.querySelector('.preview');
  if (!preview) return;

  if (!bgBitmap) {
    preview.classList.add("scroll-mode");
  } else {
    preview.classList.remove("scroll-mode");
  }
}

updateScrollMode();
</script>

<!------------ PIKKUKUVAT --------->
<div id="thumbs" class="thumbs">

<div class="thumb-title">Tekstit</div>
<div class="thumb"><img src="https://i.postimg.cc/NMC5RjM8/jouluteksti.png"></div>
<div class="thumb"><img src="https://i.postimg.cc/k4cR5PL4/621005e7-5c3c-4c82-b4cd-7a51d7eb2346.png"></div>
<div class="thumb"><img src="https://i.postimg.cc/SxPGkWcB/tekstinauha.png"></div>
<div class="thumb"><img src="https://i.postimg.cc/76bJb2V2/Teksti.png"></div>
<div class="thumb"><img src="
