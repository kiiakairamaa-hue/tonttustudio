<!DOCTYPE html>
<html lang="fi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&display=swap" rel="stylesheet">
<title>TonttuStudio — v4 active outline (fresh copy)</title>

<style>
:root{ --red:#8d1b1b; --gold:#f6d778; --gold-edge:#7f642a; }
html,body{height:100%}
body{
  margin:0; background:var(--red); color:#fff;
  font-family:system-ui; -webkit-font-smoothing:antialiased;
}
.wrap{max-width:720px;margin:0 auto;padding:16px}

h1{
  margin:8px 0 12px; font-size:42px; text-align:center;
  color:#ffd700; text-shadow:0 2px 0 rgba(0,0,0,.25),0 0 16px rgba(243,209,119,.35);
  font-family:'Emilys Candy',cursive; font-weight:700;
}

.toolbar{
  display:flex; gap:10px; justify-content:center; margin-bottom:12px;
  overflow-x:auto; padding:2px;
}
button,label.button{
  background:linear-gradient(#ffe7a5,#e5c66d); color:#2b1c00;
  border:2px solid var(--gold-edge); padding:10px 18px; font-weight:700;
  border-radius:24px; font-size:16px; box-shadow:0 4px 0 #6e5624,0 8px 18px rgba(0,0,0,.25);
  cursor:pointer;
}
input[type=file]{display:none}

.preview{
  width:100%; aspect-ratio:1/1; background:#000; border-radius:16px;
  border:3px solid var(--gold); overflow:hidden; position:relative;
}
canvas{width:100%;height:100%;display:block;background:#000}

.note{ color:#ffe7a5; font-size:13px; margin:8px 0 12px; }

.thumbs{
  display:grid; grid-template-columns:repeat(5,1fr);
  gap:10px; padding:4px 2px 2px; margin-bottom:6px;
}
.thumb{
  border-radius:14px; padding:6px; background:rgba(0,0,0,.55);
  box-shadow:0 0 0 2px rgba(243,209,119,.30) inset,0 6px 16px rgba(0,0,0,.35);
  display:flex; align-items:center; justify-content:center;
  aspect-ratio:1/1; overflow:hidden;
}
.thumb img{max-width:100%;max-height:100%;user-select:none;cursor:pointer;-webkit-user-drag:none;}

.thumb-title{ grid-column:1/-1; font-weight:700; padding:6px 0 2px; color:#ffd700;}

.remove-btn{
  position:absolute;color:#fff;font-size:22px;font-weight:900;
  text-shadow:0 1px 2px rgba(0,0,0,.7);
  transform:translate(-50%,-50%); z-index:5; pointer-events:auto;
}

.credits{
  text-align:right;margin-top:40px;padding:0 18px 16px 0;font-size:15px;color:#ffe7a5;
  text-shadow:0 1px 3px rgba(0,0,0,.6);
}
.credits strong{color:var(--gold)}
</style>

<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>
</head>

<body>
<div class="wrap">

<h1>TonttuStudio</h1>

<div class="toolbar">
  <label for="file" class="button">Avaa kuva</label>
  <input id="file" type="file" accept="image/*,image/heic,image/heif,image/webp"/>
  <button id="save">Tallenna</button>
  <button id="clear">Tyhjennä</button>
</div>

<div class="preview" id="preview">
  <canvas id="c" width="1200" height="1200"></canvas>
</div>

<div class="note">Valitse tausta, lisää kirjastosta koriste. Tausta lukittuu ensimmäisestä koristeesta.</div>

<script>
(function(){
'use strict';

const MAX_LONG_EDGE=3000;
const BG_MIN=0.2,BG_MAX=6.0;
const STICKER_MIN=0.4,STICKER_MAX=10.0;
const BASE_STICKER=300;

const file=document.getElementById('file');
const save=document.getElementById('save');
const clearBtn=document.getElementById('clear');
const canvas=document.getElementById('c');
const ctx=canvas.getContext('2d',{alpha:false,desynchronized:true});
const preview=document.getElementById('preview');

const back=document.createElement('canvas');
back.width=canvas.width; back.height=canvas.height;
const bctx=back.getContext('2d',{alpha:false});

let bgBitmap=null;
let bg={x:0,y:0,scale:1};
let bgLocked=false;

let stickers=[];
let activeIndex=-1;

let needsRedraw=true;
let pointers=new Map();
let draggingBG=false;
let stickerGesture=null;

const delBtn=document.createElement('div');
delBtn.className='remove-btn';
delBtn.textContent='x';
delBtn.style.display='none';
preview.appendChild(delBtn);

delBtn.addEventListener('click',()=>{
  if(activeIndex>=0){
    stickers.splice(activeIndex,1);
    activeIndex=stickers.length-1;
    if(stickers.length===0) bgLocked=false;
    needsRedraw=true;
    updateDeleteButtonPosition();
  }
});

requestAnimationFrame(function loop(){
  if(needsRedraw){draw();needsRedraw=false;}
  requestAnimationFrame(loop);
});

function clearCanvas(t){(t||ctx).fillStyle='#000';(t||ctx).fillRect(0,0,canvas.width,canvas.height);}
clearCanvas(ctx);clearCanvas(bctx);

function hardResetPointers(){pointers.clear();draggingBG=false;stickerGesture=null;if(bg)bg._pinch=null;}

function resetAll(){
  bgBitmap=null; bg={x:0,y:0,scale:1}; bgLocked=false;
  stickers=[]; activeIndex=-1;
  clearCanvas(ctx); clearCanvas(bctx);
  hardResetPointers(); needsRedraw=true;
  delBtn.style.display='none';
}

async function decodeSmart(f){
  if('createImageBitmap'in window){
    try{return await createImageBitmap(f,{imageOrientation:'from-image',premultiplyAlpha:'premultiply'});}catch(_){}
  }
  const url=URL.createObjectURL(f);
  return new Promise((res,rej)=>{
    const img=new Image();
    img.onload=()=>{URL.revokeObjectURL(url);res(img)};
    img.onerror=rej; img.src=url;
  });
}

function downscaleToMaxEdge(bitmap){
  const iw=bitmap.width, ih=bitmap.height;
  const k=Math.min(MAX_LONG_EDGE/Math.max(iw,ih),1);
  const ow=Math.round(iw*k), oh=Math.round(ih*k);
  const off=document.createElement('canvas'); off.width=ow; off.height=oh;
  const g=off.getContext('2d'); g.imageSmoothingEnabled=true;
  g.drawImage(bitmap,0,0,ow,oh); return off;
}

function fitContain(){
  const cw=canvas.width,ch=canvas.height,iw=bgBitmap.width,ih=bgBitmap.height;
  const s=Math.min(cw/iw,ch/ih); bg.scale=s;
  bg.x=(cw-iw*s)/2; bg.y=(ch-ih*s)/2;
}

function clampBgScale(){
  const cw=canvas.width,ch=canvas.height;
  const iw=bgBitmap?.width||cw, ih=bgBitmap?.height||ch;
  const contain=Math.min(cw/iw,ch/ih);
  bg.scale=Math.max(contain*BG_MIN,Math.min(BG_MAX,bg.scale));
}

function renderTo(t){
  t.fillStyle='#000'; t.fillRect(0,0,canvas.width,canvas.height);
  if(bgBitmap){
    t.save();
    t.imageSmoothingEnabled=true;
    t.translate(bg.x,bg.y); t.scale(bg.scale,bg.scale);
    t.drawImage(bgBitmap,0,0); t.restore();
  }
  for(const st of stickers){
    t.save();
    t.translate(st.x,st.y); t.rotate(st.rot); t.scale(st.scale,st.scale);
    const img=st.bitmap,w=img.width,h=img.height;
    const scale=Math.min(BASE_STICKER/w,BASE_STICKER/h);
    t.scale(scale,scale);
    t.drawImage(img,-w/2,-h/2);
    t.restore();
  }
}

function roundedRectPath(g,x,y,w,h,r){
  const rr=Math.min(r,Math.abs(w)/2,Math.abs(h)/2);
  g.beginPath();
  g.moveTo(x+rr,y);
  g.lineTo(x+w-rr,y);
  g.quadraticCurveTo(x+w,y,x+w,y+rr);
  g.lineTo(x+w,y+h-rr);
  g.quadraticCurveTo(x+w,y+h,x+w-rr,y+h);
  g.lineTo(x+rr,y+h);
  g.quadraticCurveTo(x,y+h,x,y+h-rr);
  g.lineTo(x,y+rr);
  g.quadraticCurveTo(x,y,x+rr,y);
  g.closePath();
}

function drawOutlineForActive(){
  if(activeIndex<0||!stickers[activeIndex])return;
  const st=stickers[activeIndex];

  ctx.save();
  ctx.translate(st.x,st.y); ctx.rotate(st.rot);
  const img=st.bitmap,w=img.width,h=img.height;
  const inner=Math.min(BASE_STICKER/w,BASE_STICKER/h)*st.scale;
  ctx.scale(inner,inner);

  ctx.lineWidth=3/inner;
  ctx.strokeStyle='#f6d778';
  ctx.shadowColor='rgba(246,215,120,.35)';
  ctx.shadowBlur=14;
  ctx.lineJoin='round';

  roundedRectPath(ctx,-w/2,-h/2,w,h,Math.min(w,h)*0.12);
  ctx.stroke();
  ctx.restore();

  updateDeleteButtonPosition();
}

function draw(){
  renderTo(bctx);
  ctx.drawImage(back,0,0);
  drawOutlineForActive();
}

function updateDeleteButtonPosition(){
  if(activeIndex<0||!stickers[activeIndex]){delBtn.style.display='none';return;}
  delBtn.style.display='block';
  const st=stickers[activeIndex];
  const rect=canvas.getBoundingClientRect();
  const scaleX=rect.width/canvas.width;
  const scaleY=rect.height/canvas.height;
  const img=st.bitmap,w=img.width,h=img.height;
  const innerScale=Math.min(BASE_STICKER/w,BASE_STICKER/h)*st.scale;
  const px=(st.x+(w/2)*innerScale)*scaleX+rect.left;
  const py=(st.y-(h/2)*innerScale)*scaleY+rect.top;

  const pr=preview.getBoundingClientRect();
  delBtn.style.left=(px-pr.left+6)+'px';
  delBtn.style.top=(py-pr.top-6)+'px';
}

file.addEventListener('change',async e=>{
  const f=e.target.files?.[0]; if(!f)return;

  const label=document.querySelector('label[for="file"]');
  const txt=label.textContent;
  label.textContent='LATAAN...'; label.style.opacity='0.6'; label.style.pointerEvents='none';

  try{
    const isHeic=(/\.hei[cf]$/i.test(f.name||'')||/heic|heif/i.test(f.type||''));
    if(isHeic&&window.heic2any){
      const png=await window.heic2any({blob:f,toType:'image/png'});
      const url=URL.createObjectURL(png);
      const img=await new Promise((r,j)=>{const im=new Image();im.onload=()=>r(im);im.onerror=j;im.src=url;});
      URL.revokeObjectURL(url);

      const off=document.createElement('canvas');
      off.width=img.naturalWidth; off.height=img.naturalHeight;
      off.getContext('2d').drawImage(img,0,0);
      bgBitmap=downscaleToMaxEdge(off);
    }else{
      const bmp=await decodeSmart(f
